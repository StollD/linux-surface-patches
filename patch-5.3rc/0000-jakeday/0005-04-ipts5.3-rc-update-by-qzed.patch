From f0d2fa6a996e7f65ea3ac86d87943f9bc40de0a6 Mon Sep 17 00:00:00 2001
From: kitakar5525 <34676735+kitakar5525@users.noreply.github.com>
Date: Tue, 6 Aug 2019 08:49:41 +0900
Subject: [PATCH] ipts5.3-rc: update by qzed

---
 drivers/gpu/drm/i915/intel_ipts.c | 22 ++++++++++++++++++----
 1 file changed, 18 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/intel_ipts.c b/drivers/gpu/drm/i915/intel_ipts.c
index 5ca04106e..b9f788dae 100644
--- a/drivers/gpu/drm/i915/intel_ipts.c
+++ b/drivers/gpu/drm/i915/intel_ipts.c
@@ -195,12 +195,19 @@ static int create_ipts_context(void)
 		goto err_unlock;
 	}
 
-	ce = intel_context_create(ipts_ctx, dev_priv->engine[RCS0]);
+	ce = i915_gem_context_get_engine(ipts_ctx, RCS0);
 	if (IS_ERR(ce)) {
 		DRM_ERROR("Failed to create intel context (error %ld)\n",
 			  PTR_ERR(ce));
 		ret = PTR_ERR(ce);
-		goto err_unlock;
+		goto err_ctx;
+	}
+
+	ret = intel_context_pin(ce);
+	if (ret) {
+		DRM_ERROR("Failed to pin intel context (error %d)\n", ret);
+		ret = PTR_ERR(ce);
+		goto err_ctx;
 	}
 
 	ret = execlists_context_deferred_alloc(ce, ce->engine);
@@ -226,7 +233,9 @@ static int create_ipts_context(void)
 	return 0;
 
 err_ctx:
-	if (ipts_ctx)
+	if (!IS_ERR_OR_NULL(ce))
+		intel_context_put(ce);
+	if (!IS_ERR_OR_NULL(ipts_ctx))
 		i915_gem_context_put(ipts_ctx);
 
 err_unlock:
@@ -244,7 +253,11 @@ static void destroy_ipts_context(void)
 
 	ipts_ctx = intel_ipts.ipts_context;
 
-	ce = intel_context_create(ipts_ctx, dev_priv->engine[RCS0]);
+	ce = i915_gem_context_lookup_engine(ipts_ctx, RCS0);
+	if (IS_ERR(ce)) {
+		DRM_ERROR("i915_gem_context_lookup_engine failed: %ld\n", PTR_ERR(ce));
+		return;
+	}
 
 	/* Initialize the context right away.*/
 	ret = i915_mutex_lock_interruptible(intel_ipts.dev);
@@ -255,6 +268,7 @@ static void destroy_ipts_context(void)
 
 	execlists_context_unpin(ce);
 	intel_context_unpin(ce);
+	intel_context_put(ce);
 	i915_gem_context_put(ipts_ctx);
 
 	mutex_unlock(&intel_ipts.dev->struct_mutex);
-- 
2.22.0

